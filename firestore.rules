rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check user roles
    function isOneOfRoles(rsc, array) {
      return rsc.data.roles[request.auth.token.email] in array;
    }

    // Rules for 'paciente' collection
    match /paciente/{pacienteId} {
      // Allow read/write access only to the authenticated user who owns the document
      allow read, write: if request.auth != null && request.auth.uid == pacienteId;
    }

    // Rules for 'journal_entries' collection
    match /journal_entries/{entryId} {
      // A user can create an entry if they are logged in and the entry is for themselves
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // A user can read, update, and delete their own entries
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Rules for 'tareas' collection
    match /tareas/{tareaId} {
      // A user can read or update a task if they are logged in and the task's pacienteId matches their own UID.
      allow read, update: if request.auth != null && resource.data.pacienteId == request.auth.uid;

      // Allow creation of tasks by any authenticated user (e.g., from the app) or by the IA (Cloud Function)
      allow create: if request.auth != null;
    }

    // Rules for stories (example from documentation)
    match /stories/{story} {
      allow create: if request.auth != null;
      allow read, delete: if request.auth != null && resource.data.author == request.auth.uid;
      allow update: if request.auth != null && resource.data.author == request.auth.uid;
    }
  }
}
